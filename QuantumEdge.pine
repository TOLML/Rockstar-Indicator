//@version=6
// =============================================================================
// QUANTUM EDGE v2 — EVENT-BASED HIGH-CONFIDENCE SIGNALS
// =============================================================================
// Buy-focused long-term timing — independent buy/sell signals
// Backtested: BTC 71% accuracy at 52d, SPY 78% at 52d (buy_confirm=3)
// Signals can repeat: 3 buys in a row = "keep accumulating"
// =============================================================================

indicator(title="Quantum Edge v2", shorttitle="QE2", overlay=true, max_bars_back=500)

// =============================================================================
// INPUTS
// =============================================================================
group_strength = "Signal Strength"
strengthInput = input.string("3 — Moderate", "Strength", options=["1 — Ultra Conservative", "2 — Conservative", "3 — Moderate", "4 — Active", "5 — Balanced", "6 — Liberal"], group=group_strength, tooltip="Controls how many signals appear and how strict the filters are.\n\n1 Ultra Conservative: Fewest signals, highest accuracy (4/4 confirms)\n2 Conservative: High accuracy, reasonable count (3/3 confirms)\n3 Moderate: Recommended default (3/2 confirms)\n4 Active: Between moderate and balanced (2/2 confirms, longer cooldowns)\n5 Balanced: More signals, still filtered (2/2 confirms)\n6 Liberal: Most signals (1/1 confirms)")

// Derive strength level
strengthLevel = strengthInput == "1 — Ultra Conservative" ? 1 : strengthInput == "2 — Conservative" ? 2 : strengthInput == "3 — Moderate" ? 3 : strengthInput == "4 — Active" ? 4 : strengthInput == "5 — Balanced" ? 5 : 6

// Map strength to parameters:
//                          UltraCon  Conserv  Moderate  Active  Balanced  Liberal
// Buy Confirms (of 4):       4         3         3        2        2        1
// Sell Confirms (of 4):      3         3         2        2        2        1
// Buy Cooldown (bars):       20        15        10       8        5        5
// Sell Cooldown (bars):      25        20        15       12       10       10
// Pullback Sensitivity:      7         5         5        4        5        3
// Extension Sensitivity:     10        8         8        7        8        5
buyConfirmMin = strengthLevel <= 2 ? (strengthLevel == 1 ? 4 : 3) : strengthLevel == 3 ? 3 : strengthLevel <= 5 ? 2 : 1
sellConfirmMin = strengthLevel <= 2 ? 3 : strengthLevel == 3 ? 2 : strengthLevel <= 5 ? 2 : 1
buyCooldown = strengthLevel == 1 ? 20 : strengthLevel == 2 ? 15 : strengthLevel == 3 ? 10 : strengthLevel == 4 ? 8 : 5
sellCooldown = strengthLevel == 1 ? 25 : strengthLevel == 2 ? 20 : strengthLevel == 3 ? 15 : strengthLevel == 4 ? 12 : 10
pullbackPct = strengthLevel == 1 ? 7.0 : strengthLevel == 4 ? 4.0 : strengthLevel <= 5 ? 5.0 : 3.0
extensionPct = strengthLevel == 1 ? 10.0 : strengthLevel == 4 ? 7.0 : strengthLevel <= 5 ? 8.0 : 5.0

group_pullback = "Pullback Detection"
pullbackLookback = input.int(20, "Lookback Period", minval=10, maxval=50, group=group_pullback)
useATRAdapt = input.bool(true, "ATR-Adaptive Thresholds", group=group_pullback, tooltip="Auto-adjusts pullback/extension thresholds based on asset volatility.\nCritical for cross-asset compatibility (crypto vs stocks).")

group_technical = "Technical Parameters"
rsiLen = input.int(14, "RSI Length", minval=7, maxval=30, group=group_technical)
rsiOversold = input.int(30, "RSI Oversold", minval=20, maxval=40, group=group_technical)
rsiRecovery = input.int(35, "RSI Recovery", minval=25, maxval=50, group=group_technical)
rsiOverbought = input.int(70, "RSI Overbought", minval=60, maxval=85, group=group_technical)
rsiExhaustion = input.int(65, "RSI Exhaustion", minval=55, maxval=80, group=group_technical)
stochLen = input.int(14, "Stochastic Length", minval=5, maxval=30, group=group_technical)
stochSmoothK = input.int(3, "Stoch Smooth K", minval=1, maxval=5, group=group_technical)
smaSlowLen = input.int(200, "SMA Slow Length", minval=100, maxval=300, group=group_technical)
emaFastLen = input.int(50, "EMA Fast Length", minval=10, maxval=100, group=group_technical)
bbLen = input.int(20, "BB Length", minval=10, maxval=50, group=group_technical)
bbMult = input.float(2.0, "BB Multiplier", minval=1.5, maxval=3.0, step=0.1, group=group_technical)
kcLen = input.int(20, "KC Length", minval=10, maxval=50, group=group_technical)
kcMult = input.float(1.5, "KC Multiplier", minval=1.0, maxval=2.5, step=0.1, group=group_technical)
squeezeMinBars = input.int(3, "Squeeze Min Duration", minval=1, maxval=10, group=group_technical)
volMult = input.float(1.3, "Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group=group_technical)

group_display = "Display"
showBuySignals = input.bool(true, "Show Buy Signals", group=group_display)
showSellSignals = input.bool(true, "Show Sell Signals", group=group_display)
showSqueezeBG = input.bool(true, "Show Squeeze Background", group=group_display)
showDashboard = input.bool(false, "Show Dashboard", group=group_display)
buyColor = input.color(#10B981, "Buy Color", group=group_display)
strongBuyColor = input.color(#F59E0B, "Strong Buy Color", group=group_display)
sellColor = input.color(#EF4444, "Sell Color", group=group_display)
strongSellColor = input.color(#DC2626, "Strong Sell Color", group=group_display)

// =============================================================================
// CORE INDICATORS
// =============================================================================
rsi = ta.rsi(close, rsiLen)
stochK = ta.stoch(close, high, low, stochLen)
stochD = ta.sma(stochK, stochSmoothK)
smaSlow = ta.sma(close, smaSlowLen)
emaFast = ta.ema(close, emaFastLen)
atr = ta.atr(14)
avgVol = ta.sma(volume, 20)

// OBV
obvRaw = ta.cum(volume * (close > close[1] ? 1.0 : close < close[1] ? -1.0 : 0.0))
obvMA = ta.sma(obvRaw, 20)

// =============================================================================
// BOLLINGER BANDS + KELTNER CHANNELS → SQUEEZE
// =============================================================================
bbBasis = ta.sma(close, bbLen)
bbDev = bbMult * ta.stdev(close, bbLen)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

kcBasis = ta.sma(close, kcLen)
kcRange = ta.sma(ta.tr, kcLen)
kcUpper = kcBasis + kcRange * kcMult
kcLower = kcBasis - kcRange * kcMult

sqzOn = bbLower > kcLower and bbUpper < kcUpper
sqzOff = bbLower < kcLower and bbUpper > kcUpper

// Squeeze duration
sqzCount = ta.barssince(not sqzOn)
sqzDuration = na(sqzCount) ? 0 : sqzCount

// Squeeze release
sqzRelease = sqzOn[1] and sqzOff and sqzDuration[1] >= squeezeMinBars

// Squeeze momentum (linreg)
hhKC = ta.highest(high, kcLen)
llKC = ta.lowest(low, kcLen)
sqzSrc = close - (math.avg(hhKC, llKC) + ta.sma(close, kcLen)) / 2
sqzMom = ta.linreg(sqzSrc, kcLen, 0)
momIncreasing = sqzMom > sqzMom[1]

// =============================================================================
// ATR-ADAPTIVE THRESHOLDS
// =============================================================================
avgAtrPct = ta.sma(atr / close * 100, 50)
safeAtrPct = na(avgAtrPct) ? pullbackPct : avgAtrPct
adaptivePullback = useATRAdapt ? math.max(2.0, math.min(25.0, safeAtrPct * pullbackPct / 2)) : pullbackPct
adaptiveExtension = useATRAdapt ? math.max(3.0, math.min(30.0, safeAtrPct * extensionPct / 2)) : extensionPct

// =============================================================================
// DERIVED SIGNALS
// =============================================================================
recentHigh = ta.highest(high, pullbackLookback)
drawdownFromHigh = (recentHigh - close) / recentHigh * 100
pctFromSMA = not na(smaSlow) and smaSlow > 0 ? (close - smaSlow) / smaSlow * 100 : 0.0

// RSI history (5-bar rolling min/max)
rsiMin5 = ta.lowest(rsi, 5)
rsiMax5 = ta.highest(rsi, 5)

// =============================================================================
// BUY EVENT DETECTION — THREE TIERS
// =============================================================================

// ── Tier 1: TRIGGER EVENT (at least one must fire) ──
// A) Meaningful pullback from recent high
pullbackEvent = drawdownFromHigh >= adaptivePullback

// B) SMA200 bounce: crossed back above from below
smaBounce = not na(smaSlow) and close[1] < smaSlow[1] and close >= smaSlow

// C) Squeeze release with upward momentum
sqzReleaseUp = sqzRelease and momIncreasing

buyTrigger = pullbackEvent or smaBounce or sqzReleaseUp

// ── Tier 2: CONFIRMATION (count how many of 4 pass) ──
// 1. RSI was oversold recently AND now recovering
rsiWasOversold = rsiMin5 < rsiOversold
rsiRecoveringCond = rsi > rsiRecovery and rsiWasOversold

// 2. Stochastic K crossing above D from oversold zone
stochReversal = stochK > stochD and stochK[1] <= stochD[1] and stochK < 50

// 3. Squeeze momentum turning up from negative
momentumTurn = momIncreasing and sqzMom < 0

// 4. Volume confirmation
volConfirm = volume > avgVol * volMult

buyConfirmCount = (rsiRecoveringCond ? 1 : 0) + (stochReversal ? 1 : 0) + (momentumTurn ? 1 : 0) + (volConfirm ? 1 : 0)

// ── Tier 3: CONTEXT (at least one) ──
trendOK = not na(smaSlow) ? close > smaSlow * 0.90 : true
obvBullish = obvRaw > obvMA
nearEMA = close < emaFast * 1.02

buyContext = trendOK or obvBullish or nearEMA

// ── COMBINE ──
buyRaw = buyTrigger and buyConfirmCount >= buyConfirmMin and buyContext
strongBuyRaw = buyTrigger and buyConfirmCount >= 3 and trendOK and (obvBullish or nearEMA)

// =============================================================================
// SELL EVENT DETECTION — THREE TIERS
// =============================================================================

// ── Tier 1: TRIGGER EVENT ──
// A) Price extended above SMA200
extendedEvent = pctFromSMA > adaptiveExtension

// B) RSI was overbought and now exhausting
rsiWasOverbought = rsiMax5 > rsiOverbought
rsiExhaustingCond = rsi < rsiExhaustion and rsiWasOverbought

sellTrigger = extendedEvent or rsiExhaustingCond

// ── Tier 2: CONFIRMATION (count how many of 4 pass) ──
// 1. RSI declining for 2 bars while above 50
rsiDeclining = rsi < rsi[1] and rsi[1] < rsi[2] and rsi > 50

// 2. Stochastic K crossing below D from overbought
stochCrossDown = stochK < stochD and stochK[1] >= stochD[1] and stochK > 50

// 3. Momentum fading from positive
momentumFade = sqzMom < sqzMom[1] and sqzMom > 0

// 4. Volume distribution spike
volDist = volume > avgVol * (volMult * 1.3)

sellConfirmCount = (rsiDeclining ? 1 : 0) + (stochCrossDown ? 1 : 0) + (momentumFade ? 1 : 0) + (volDist ? 1 : 0)

// ── Tier 3: CONTEXT ──
aboveSMA = not na(smaSlow) ? close > smaSlow : false
obvBearish = obvRaw < obvMA

sellRaw = sellTrigger and sellConfirmCount >= sellConfirmMin and aboveSMA
strongSellRaw = sellTrigger and sellConfirmCount >= 3 and aboveSMA and obvBearish

// =============================================================================
// COOLDOWN (same-direction only, independent buy/sell)
// =============================================================================
var int lastBuyBar = -999
var int lastSellBar = -999

buyCooldownMet = bar_index - lastBuyBar >= buyCooldown
sellCooldownMet = bar_index - lastSellBar >= sellCooldown

buySignal = buyRaw and buyCooldownMet
strongBuySignal = strongBuyRaw and buyCooldownMet
sellSignal = sellRaw and sellCooldownMet
strongSellSignal = strongSellRaw and sellCooldownMet

if buySignal
    lastBuyBar := bar_index
if sellSignal
    lastSellBar := bar_index

// =============================================================================
// VISUALIZATION
// =============================================================================

// Squeeze background
bgcolor(showSqueezeBG and sqzOn ? color.new(#2962FF, 93) : na, title="Squeeze Active")

// Buy signals
plotshape(showBuySignals and buySignal and not strongBuySignal, style=shape.labelup, location=location.belowbar, color=color.new(buyColor, 0), size=size.normal, text="BUY", textcolor=color.white, title="Buy Signal")
plotshape(showBuySignals and strongBuySignal, style=shape.labelup, location=location.belowbar, color=color.new(strongBuyColor, 0), size=size.large, text="BUY", textcolor=color.white, title="Strong Buy Signal")

// Sell signals
plotshape(showSellSignals and sellSignal and not strongSellSignal, style=shape.labeldown, location=location.abovebar, color=color.new(sellColor, 0), size=size.normal, text="SELL", textcolor=color.white, title="Sell Signal")
plotshape(showSellSignals and strongSellSignal, style=shape.labeldown, location=location.abovebar, color=color.new(strongSellColor, 0), size=size.large, text="SELL", textcolor=color.white, title="Strong Sell Signal")

// SMA reference line
plot(smaSlow, color=color.new(#9E9E9E, 50), linewidth=1, title="SMA 200")

// =============================================================================
// DASHBOARD
// =============================================================================
if showDashboard and barstate.islast
    var table dash = table.new(position.top_right, 2, 10, border_width=1, border_color=color.new(#37474F, 0), bgcolor=color.new(#263238, 0))
    strengthLabel = strengthLevel == 1 ? "ULTRA CON" : strengthLevel == 2 ? "CONSERV" : strengthLevel == 3 ? "MODERATE" : strengthLevel == 4 ? "ACTIVE" : strengthLevel == 5 ? "BALANCED" : "LIBERAL"
    table.cell(dash, 0, 0, "QE v2 [" + strengthLabel + "]", bgcolor=color.new(#1565C0, 0), text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 0, "STATUS", bgcolor=color.new(#1565C0, 0), text_color=color.white, text_size=size.small)
    table.cell(dash, 0, 1, "Buy Confirms", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 1, str.tostring(buyConfirmCount) + "/4", bgcolor=buyConfirmCount >= buyConfirmMin ? color.new(#10B981, 20) : color.new(#EF4444, 20), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 2, "Sell Confirms", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 2, str.tostring(sellConfirmCount) + "/4", bgcolor=sellConfirmCount >= sellConfirmMin ? color.new(#EF4444, 20) : color.new(#263238, 40), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 3, "RSI", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    rsiColor = rsi < rsiOversold ? color.new(#10B981, 0) : rsi > rsiOverbought ? color.new(#EF4444, 0) : color.new(#9E9E9E, 0)
    table.cell(dash, 1, 3, str.tostring(rsi, "#.0"), bgcolor=rsiColor, text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 4, "% from SMA", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    smaColor = pctFromSMA < 0 ? color.new(#10B981, 0) : pctFromSMA > 10 ? color.new(#EF4444, 0) : color.new(#9E9E9E, 0)
    table.cell(dash, 1, 4, str.tostring(pctFromSMA, "#.1") + "%", bgcolor=smaColor, text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 5, "Pullback", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    pbColor = drawdownFromHigh >= adaptivePullback ? color.new(#F59E0B, 0) : color.new(#263238, 40)
    table.cell(dash, 1, 5, str.tostring(drawdownFromHigh, "#.1") + "%", bgcolor=pbColor, text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 6, "Squeeze", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    sqzStatus = sqzOn ? "ACTIVE" : sqzRelease ? "RELEASE" : "OFF"
    sqzColor = sqzOn ? color.new(#2962FF, 0) : sqzRelease ? color.new(#F59E0B, 0) : color.new(#263238, 40)
    table.cell(dash, 1, 6, sqzStatus, bgcolor=sqzColor, text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 7, "OBV", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 7, obvBullish ? "ACCUM" : "DISTRIB", bgcolor=obvBullish ? color.new(#10B981, 0) : color.new(#EF4444, 0), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 8, "Buy Cooldown", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    barsToNext = math.max(0, buyCooldown - (bar_index - lastBuyBar))
    table.cell(dash, 1, 8, buyCooldownMet ? "READY" : str.tostring(barsToNext) + " bars", bgcolor=buyCooldownMet ? color.new(#10B981, 0) : color.new(#F59E0B, 0), text_color=color.white, text_size=size.tiny)
    table.cell(dash, 0, 9, "Sell Cooldown", bgcolor=color.new(#263238, 0), text_color=color.white, text_size=size.tiny)
    barsToNextSell = math.max(0, sellCooldown - (bar_index - lastSellBar))
    table.cell(dash, 1, 9, sellCooldownMet ? "READY" : str.tostring(barsToNextSell) + " bars", bgcolor=sellCooldownMet ? color.new(#10B981, 0) : color.new(#F59E0B, 0), text_color=color.white, text_size=size.tiny)

// =============================================================================
// ALERTS
// =============================================================================
alertcondition(buySignal and not strongBuySignal, title="BUY Signal", message="QE2 BUY: {{ticker}} at {{close}} — pullback reversal confirmed")
alertcondition(strongBuySignal, title="STRONG BUY Signal", message="QE2 STRONG BUY: {{ticker}} at {{close}} — high conviction entry (3+ confirmations)")
alertcondition(sellSignal and not strongSellSignal, title="SELL Signal", message="QE2 SELL: {{ticker}} at {{close}} — extended peak detected")
alertcondition(strongSellSignal, title="STRONG SELL Signal", message="QE2 STRONG SELL: {{ticker}} at {{close}} — high conviction exit (3+ confirmations + distribution)")
